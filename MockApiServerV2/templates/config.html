<!-- templates/config.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Mock API Config</title>
    <style>
        body { font-family: Arial, sans-serif; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; text-align: left; border: 1px solid #ddd; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h2>Настройка маршрутов Mock API</h2>

    <table id="routesTable">
        <thead>
            <tr>
                <th>Маршрут</th>
                <th>Методы</th>
                <th>Ответ (GET)</th>
                <th>Ответ (POST)</th>
                <th>Проверка</th>
            </tr>
        </thead>
        <tbody>
            {% for route, details in routes.items() %}
            <tr>
                <td>{{ route }}</td>
                <td>{{ details.methods | join(", ") }}</td>
                <td>{{ details.response.GET.message if details.response.GET }}</td>
                <td>{{ details.response.POST.message if details.response.POST }}</td>
                <td><a href="{{ '/' + route }}" target="_blank">Перейти</a></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h3>Добавить/Обновить маршрут</h3>
    <form id="routeForm">
        <label>Маршрут:</label>
        <input type="text" id="route" required><br><br>

        <label>Методы:</label>
        <select id="methods" multiple>
            <option value="GET">GET</option>
            <option value="POST">POST</option>
        </select><br><br>

        <label>Ответ для GET:</label>
        <input type="text" id="responseGet" placeholder="например, Меня зовут {user_name}, мне {user_age} лет"><br><br>

        <label>Ответ для POST:</label>
        <input type="text" id="responsePost" placeholder="например, Меня зовут {user_name}, мне {user_age} лет"><br><br>

        <h4>Сопоставление параметров</h4>
        <label>Параметр в URL:</label>
        <input type="text" id="paramName" placeholder="например, name"><br><br>

        <label>Переменная в ответе:</label>
        <input type="text" id="mappedName" placeholder="например, user_name"><br><br>

        <button type="button" onclick="addOrUpdateMapping()">Добавить сопоставление</button><br><br>

        <button type="button" onclick="addOrUpdateRoute()">Добавить/Обновить маршрут</button>
    </form>

    <script>
        let paramMappings = {};

        function addOrUpdateMapping() {
            const paramName = document.getElementById("paramName").value;
            const mappedName = document.getElementById("mappedName").value;

            if (paramName && mappedName) {
                paramMappings[paramName] = mappedName;
                alert(`Добавлено сопоставление: ${paramName} → ${mappedName}`);
            } else {
                alert("Введите параметры для сопоставления.");
            }
        }

        async function addOrUpdateRoute() {
            const route = document.getElementById("route").value;
            const methods = Array.from(document.getElementById("methods").selectedOptions).map(opt => opt.value);
            const responseGet = document.getElementById("responseGet").value;
            const responsePost = document.getElementById("responsePost").value;

            const routeData = {
                route: route,
                methods: methods,
                response: {
                    GET: responseGet ? { "message": responseGet } : {},
                    POST: responsePost ? { "message": responsePost } : {}
                },
                param_mappings: paramMappings
            };

            const response = await fetch('/api/routes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(routeData)
            });
            const result = await response.json();
            if (result.success) {
                alert("Маршрут успешно добавлен или обновлен!");
                location.reload();
            } else {
                alert("Ошибка: " + result.error);
            }
        }
    </script>
</body>
</html>
